name: CI

# Controls when the action will run. 
on:
  # Triggers the workflow on push but only for the main branch
  push:
    branches: [ main ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to Docker
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Check files
        run: ls -l

      - name: Push to Docker Hub
        uses: docker/build-push-action@v2
        with:
          dockerfile: ci/Dockerfile
          context: .
          push: true
          tags: fr0mhell/django-examples:latest

  deploy:
    name: Deploy from Docker image
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: executing remote ssh commands to deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.YA_HOST }}
          username: ${{ secrets.YA_USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.YA_PASSPHRASE }}
          script: |
            sudo docker pull fr0mhell/django-examples
            sudo docker stop $(sudo docker ps -a -q)
            sudo docker run --rm -d -p 8000:8000 fr0mhell/django-examples
